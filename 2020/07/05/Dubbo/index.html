<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dubbo | o.0</title><meta name="description" content="Dubbo一、分布式基础理论1.1什么是分布式系统《分布式系统原理与泛型》中定义：“分布式系统是独立计算机的集合，这些计算机对于用户来说就像单个相关系统” 随着互联网的发展，网站应用的规模不断扩大，常规的垂直应用框架已经无法应对，分布式服务架构以及流动计算机架构势在必行，亟需&#x3D;&#x3D;一个治理系统&#x3D;&#x3D;确保架构有条不紊的演进。 1.2发展演变  All In One 单一应用架构：当网站流量很小时，只需一"><meta name="author" content="NicZSAMA"><meta name="copyright" content="NicZSAMA"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://gakkisama.com/2020/07/05/Dubbo/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Dubbo"><meta property="og:url" content="http://gakkisama.com/2020/07/05/Dubbo/"><meta property="og:site_name" content="o.0"><meta property="og:description" content="Dubbo一、分布式基础理论1.1什么是分布式系统《分布式系统原理与泛型》中定义：“分布式系统是独立计算机的集合，这些计算机对于用户来说就像单个相关系统” 随着互联网的发展，网站应用的规模不断扩大，常规的垂直应用框架已经无法应对，分布式服务架构以及流动计算机架构势在必行，亟需&#x3D;&#x3D;一个治理系统&#x3D;&#x3D;确保架构有条不紊的演进。 1.2发展演变  All In One 单一应用架构：当网站流量很小时，只需一"><meta property="og:image" content="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200723224858.jpg"><meta property="article:published_time" content="2020-07-05T01:39:16.776Z"><meta property="article:modified_time" content="2020-07-23T14:53:32.756Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="I/O 和 Netty" href="http://gakkisama.com/2020/07/10/Netty/"><link rel="next" title="Swagger" href="http://gakkisama.com/2020/06/28/Swagger/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: {"languages":{"author":"作者: NicZSAMA","link":"链接: ","source":"来源: o.0","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200724150506.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Dubbo"><span class="toc-number">1.</span> <span class="toc-text">Dubbo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、分布式基础理论"><span class="toc-number">1.1.</span> <span class="toc-text">一、分布式基础理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1什么是分布式系统"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1什么是分布式系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2发展演变"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2发展演变</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3RPC"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3RPC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Dubbo-的特性"><span class="toc-number">1.1.4.</span> <span class="toc-text">2.1 Dubbo 的特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Dubbo-架构"><span class="toc-number">1.1.5.</span> <span class="toc-text">2.2 Dubbo 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-节点角色说明"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">2.2.1 节点角色说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-调用关系说明"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">2.2.2 调用关系说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、-快速开始-Dubbo"><span class="toc-number">1.2.</span> <span class="toc-text">三、 快速开始 Dubbo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-注册中心"><span class="toc-number">1.2.1.</span> <span class="toc-text">3.1 注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Multicast"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">Multicast</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zookeeper（推荐）"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">&#x3D;&#x3D;Zookeeper（推荐）&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">Nacos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Simple"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">Simple</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-安装Zookeeper"><span class="toc-number">1.2.2.</span> <span class="toc-text">3.2 安装Zookeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-集成SpringBoot"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.3 集成SpringBoot</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Dubbo常见配置及问题"><span class="toc-number">1.3.</span> <span class="toc-text">四、Dubbo常见配置及问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-启动时检查"><span class="toc-number">1.3.1.</span> <span class="toc-text">4.1 启动时检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-集群容错"><span class="toc-number">1.3.2.</span> <span class="toc-text">4.2 集群容错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-负载均衡策略"><span class="toc-number">1.3.3.</span> <span class="toc-text">4.3 负载均衡策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-服务直连"><span class="toc-number">1.3.4.</span> <span class="toc-text">4.4 服务直连</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-不同粒度的配置文件覆盖关系"><span class="toc-number">1.3.5.</span> <span class="toc-text">4.5 不同粒度的配置文件覆盖关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-Dubbo-支持多版本、多注册中心、多协议暴露服务"><span class="toc-number">1.3.6.</span> <span class="toc-text">4.6 Dubbo 支持多版本、多注册中心、多协议暴露服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、常见面试问题"><span class="toc-number">1.4.</span> <span class="toc-text">五、常见面试问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-dubbo-工作原理是什么？"><span class="toc-number">1.4.1.</span> <span class="toc-text">5.1 dubbo 工作原理是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-什么是SPI？怎样实现？"><span class="toc-number">1.4.2.</span> <span class="toc-text">5.2 什么是SPI？怎样实现？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-基于dubbo如何进行服务治理、服务降级和重试？"><span class="toc-number">1.4.3.</span> <span class="toc-text">5.3 基于dubbo如何进行服务治理、服务降级和重试？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-分布式系统如何保证系统的幂等性？"><span class="toc-number">1.4.4.</span> <span class="toc-text">5.4 分布式系统如何保证系统的幂等性？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-如何保证分布式系统接口调用的顺序性？"><span class="toc-number">1.4.5.</span> <span class="toc-text">5.5 如何保证分布式系统接口调用的顺序性？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何设计一个类似dubbo的rpc框架？"><span class="toc-number">1.4.6.</span> <span class="toc-text">如何设计一个类似dubbo的rpc框架？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-dubbo的负载均衡策略、集群容错策略、动态代理策略"><span class="toc-number">1.4.7.</span> <span class="toc-text">5.6 dubbo的负载均衡策略、集群容错策略、动态代理策略</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200723224858.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">o.0</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Dubbo</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-05 09:39:16"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2020-07-05</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-23 22:53:32"><i class="fas fa-history fa-fw"></i> 更新于 2020-07-23</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h1><h2 id="一、分布式基础理论"><a href="#一、分布式基础理论" class="headerlink" title="一、分布式基础理论"></a>一、分布式基础理论</h2><h3 id="1-1什么是分布式系统"><a href="#1-1什么是分布式系统" class="headerlink" title="1.1什么是分布式系统"></a>1.1什么是分布式系统</h3><p>《分布式系统原理与泛型》中定义：“分布式系统是独立计算机的集合，这些计算机对于用户来说就像单个相关系统”</p>
<p>随着互联网的发展，网站应用的规模不断扩大，常规的垂直应用框架已经无法应对，分布式服务架构以及流动计算机架构势在必行，亟需==一个治理系统==确保架构有条不紊的演进。</p>
<h3 id="1-2发展演变"><a href="#1-2发展演变" class="headerlink" title="1.2发展演变"></a>1.2发展演变</h3><p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705094355.jpg" alt="image"></p>
<ul>
<li><p>All In One 单一应用架构：当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。此时，用于简化增删改查工作量的数据访问框架 (ORM) 是关键。</p>
</li>
<li><p>Vertical Appliation 垂直应用架构：当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，提升效率的方法之一是将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的 Web 框架 (MVC) 是关键。</p>
</li>
<li><p>Distributed Server 分布式服务架构：当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架 (RPC) 是关键。</p>
</li>
<li><p>Elastic Computing 流动计算架构：当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。</p>
</li>
</ul>
<h3 id="1-3RPC"><a href="#1-3RPC" class="headerlink" title="1.3RPC"></a>1.3RPC</h3><ul>
<li><p>RPC（Remote Procedure Call）远程过程调用，简单的理解是一个节点请求另一个节点提供的服务</p>
</li>
<li><p>本地过程调用：如果需要将本地 student 对象的 age+1，可以实现一个 addAge() 方法，将 student 对象传入，对年龄进行更新之后返回即可，本地方法调用的函数体通过函数指针来指定。</p>
</li>
<li><p>远程过程调用：上述操作的过程中，如果 addAge() 这个方法在服务端，执行函数的函数体在远程机器上，如何告诉机器需要调用这个方法呢？</p>
</li>
</ul>
<blockquote>
<p>RPC调用过程</p>
</blockquote>
<p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705101927.png" alt="image-20200705101927036"></p>
<ol>
<li>客户端请求调用服务</li>
<li>序列化请求及参数</li>
<li>网络传输</li>
<li>服务器反序列化</li>
<li>服务器接收请求</li>
<li>服务器返回响应</li>
<li>序列化返回响应</li>
<li>网络传输</li>
<li>客户端反序列化返回响应</li>
<li>客户端获取返回响应</li>
</ol>
<p>==RPC 的核心模块：网络通信模块和序列化模块，决定了ROC框架的效率==</p>
<blockquote>
<p> 常见的ROC框架</p>
<p>Dubbo、gRPC、Thrift、HSF</p>
</blockquote>
<p>##二、Dubbo 核心概念</p>
<h3 id="2-1-Dubbo-的特性"><a href="#2-1-Dubbo-的特性" class="headerlink" title="2.1 Dubbo 的特性"></a>2.1 Dubbo 的特性</h3><ul>
<li>面向接口代理的高性能RPC调用</li>
<li>智能负载均衡</li>
<li>服务自动注册与发现</li>
<li>高度可扩展能力</li>
<li>运行期流量调度</li>
<li>可视化的服务治理与运维</li>
</ul>
<h3 id="2-2-Dubbo-架构"><a href="#2-2-Dubbo-架构" class="headerlink" title="2.2 Dubbo 架构"></a>2.2 Dubbo 架构</h3><p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705104224.jpg" alt="dubbo-architucture"></p>
<h4 id="2-2-1-节点角色说明"><a href="#2-2-1-节点角色说明" class="headerlink" title="2.2.1 节点角色说明"></a>2.2.1 节点角色说明</h4><table>
<thead>
<tr>
<th>节点</th>
<th>角色说明</th>
</tr>
</thead>
<tbody><tr>
<td>Provider</td>
<td>暴露服务的服务提供方</td>
</tr>
<tr>
<td>Consumer</td>
<td>调用远程服务的服务消费方</td>
</tr>
<tr>
<td>Registry</td>
<td>服务注册与发现的注册中心</td>
</tr>
<tr>
<td>Monitor</td>
<td>统计服务的调用次数和调用时间的监控中心</td>
</tr>
<tr>
<td>Container</td>
<td>服务运行容器</td>
</tr>
</tbody></table>
<h4 id="2-2-2-调用关系说明"><a href="#2-2-2-调用关系说明" class="headerlink" title="2.2.2 调用关系说明"></a>2.2.2 调用关系说明</h4><ol start="0">
<li><p>服务容器负责启动，加载，运行服务提供者。</p>
</li>
<li><p>服务提供者在启动时，向注册中心注册自己提供的服务。</p>
</li>
<li><p>服务消费者在启动时，向注册中心订阅自己所需的服务。</p>
</li>
<li><p>注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</p>
</li>
<li><p>服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</p>
</li>
<li><p>服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</p>
</li>
</ol>
<h2 id="三、-快速开始-Dubbo"><a href="#三、-快速开始-Dubbo" class="headerlink" title="三、 快速开始 Dubbo"></a>三、 快速开始 Dubbo</h2><h3 id="3-1-注册中心"><a href="#3-1-注册中心" class="headerlink" title="3.1 注册中心"></a>3.1 注册中心</h3><blockquote>
<p>支持的注册中心</p>
<h4 id="Multicast"><a href="#Multicast" class="headerlink" title="Multicast"></a>Multicast</h4><h4 id="Zookeeper（推荐）"><a href="#Zookeeper（推荐）" class="headerlink" title="==Zookeeper（推荐）=="></a>==Zookeeper（推荐）==</h4><h4 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h4><h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><h4 id="Simple"><a href="#Simple" class="headerlink" title="Simple"></a>Simple</h4></blockquote>
<h3 id="3-2-安装Zookeeper"><a href="#3-2-安装Zookeeper" class="headerlink" title="3.2 安装Zookeeper"></a>3.2 安装Zookeeper</h3><h3 id="3-3-集成SpringBoot"><a href="#3-3-集成SpringBoot" class="headerlink" title="3.3 集成SpringBoot"></a>3.3 集成SpringBoot</h3><blockquote>
<p>创建 common 接口工程、provider 工程和 consumer 工程，添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.dubbo/dubbo-spring-boot-starter --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.curator/curator-recipes </span></span><br><span class="line"><span class="comment">					2.7.7的dubbo-springboot-starter包中没有zk客户端包了，需要另外导入--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!--这是需要暴露服务的接口jar包，独立写一个工程打成jar包，方便 provider 和 consumer 引用--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dubbo.commonservice<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commondemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;project.basedir&#125;/src/main/resources/lib/commondemo-0.0.1.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>编写测试用服务接口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dubbo.provider.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestProviderService</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Provider 配置文件及 暴露服务实现</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">providerdemo</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">localhost:2181</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">zookeeper</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">protocol:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">20880</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@DubboService</span><span class="comment">//暴露服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProviderServiceImpl</span> <span class="keyword">implements</span> <span class="title">TestProviderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"hello1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Consumer 订阅服务中心配置及请求服务</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumerdemo</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">  <span class="comment">#注册中心地址及端口</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">localhost:2181</span></span><br><span class="line">    <span class="comment"># 注册中心协议</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">zookeeper</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">protocol:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">20880</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConsumerServiceImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DubboReference</span><span class="comment">//订阅服务</span></span><br><span class="line">    TestProviderService testProviderService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span>  testProviderService.hello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>在 SpringBootApplication 中添加 @EnableDubbo 注解 ，启动工程</p>
</blockquote>
<h2 id="四、Dubbo常见配置及问题"><a href="#四、Dubbo常见配置及问题" class="headerlink" title="四、Dubbo常见配置及问题"></a>四、Dubbo常见配置及问题</h2><h3 id="4-1-启动时检查"><a href="#4-1-启动时检查" class="headerlink" title="4.1 启动时检查"></a>4.1 启动时检查</h3><p>Dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线时，能及早发现问题，默认 <code>check=&quot;true&quot;</code>。</p>
<p>可以通过 <code>check=&quot;false&quot;</code> 关闭检查，比如，测试时，有些服务不关心，或者出现了循环依赖，必须有一方先启动。</p>
<p>另外，如果你的 Spring 容器是懒加载的，或者通过 API 编程延迟引用服务，请关闭 check，否则服务临时不可用时，会抛出异常，拿到 null 引用，如果 <code>check=&quot;false&quot;</code>，总是会返回引用，当服务恢复时，能自动连上。</p>
<h3 id="4-2-集群容错"><a href="#4-2-集群容错" class="headerlink" title="4.2 集群容错"></a>4.2 集群容错</h3><ul>
<li>Failfast Cluster</li>
</ul>
<p>快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，比如新增记录。</p>
<ul>
<li>Failsafe Cluster</li>
</ul>
<p>失败安全，出现异常时，直接忽略。通常用于写入审计日志等操作。</p>
<ul>
<li>Failback Cluster</li>
</ul>
<p>失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作。</p>
<ul>
<li>Forking Cluster</li>
</ul>
<p>并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过 <code>forks=&quot;2&quot;</code> 来设置最大并行数。</p>
<ul>
<li>Broadcast Cluster</li>
</ul>
<p>广播调用所有提供者，逐个调用，任意一台报错则报错。通常用于通知所有提供者更新缓存或日志等本地资源信息。</p>
<h3 id="4-3-负载均衡策略"><a href="#4-3-负载均衡策略" class="headerlink" title="4.3 负载均衡策略"></a>4.3 负载均衡策略</h3><ul>
<li><p>Random LoadBalance</p>
<ul>
<li><strong>随机</strong>，按权重设置随机概率。</li>
<li>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。</li>
</ul>
</li>
<li><p>RoundRobin LoadBalance</p>
<ul>
<li><strong>轮询</strong>，按公约后的权重设置轮询比率。</li>
<li>存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。</li>
</ul>
</li>
<li><p>LeastActive LoadBalance</p>
<ul>
<li><strong>最少活跃调用数</strong>，相同活跃数的随机，活跃数指调用前后计数差。</li>
<li>使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大。</li>
</ul>
</li>
<li><p>ConsistentHash LoadBalance</p>
<ul>
<li><strong>一致性 Hash</strong>，相同参数的请求总是发到同一提供者。</li>
<li>当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。</li>
<li>算法参见：<a href="http://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/Consistent_hashing</a></li>
<li>缺省只对第一个参数 Hash，如果要修改，请配置 <code>&lt;dubbo:parameter key=&quot;hash.arguments&quot; value=&quot;0,1&quot; /&gt;</code></li>
<li>缺省用 160 份虚拟节点，如果要修改，请配置 <code>&lt;dubbo:parameter key=&quot;hash.nodes&quot; value=&quot;320&quot; /&gt;</code></li>
</ul>
</li>
</ul>
<h3 id="4-4-服务直连"><a href="#4-4-服务直连" class="headerlink" title="4.4 服务直连"></a>4.4 服务直连</h3><p>在开发及测试环境下，经常需要绕过注册中心，只测试指定服务提供者，这时候可能需要点对点直连，点对点直连方式，将以服务接口为单位，忽略注册中心的提供者列表，A 接口配置点对点，不影响 B 接口从注册中心获取列表。</p>
<p> <img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705170028.jpg" alt="/user-guide/images/dubbo-directly.jpg"></p>
<h3 id="4-5-不同粒度的配置文件覆盖关系"><a href="#4-5-不同粒度的配置文件覆盖关系" class="headerlink" title="4.5 不同粒度的配置文件覆盖关系"></a>4.5 不同粒度的配置文件覆盖关系</h3><p>以 timeout 为例，下图显示了配置的查找顺序，其它 retries, loadbalance, actives 等类似：</p>
<ul>
<li>方法级优先，接口级次之，全局配置再次之。</li>
<li>如果级别一样，则消费方优先，提供方次之。</li>
</ul>
<p>其中，服务提供方配置，通过 URL 经由注册中心传递给消费方。</p>
<p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705170431.jpg" alt="dubbo-config-override"></p>
<p>（建议由服务提供方设置超时，因为一个方法需要执行多长时间，服务提供方更清楚，如果一个消费方同时引用多个服务，就不需要关心每个服务的超时设置）。</p>
<p>理论上 ReferenceConfig 中除了<code>interface</code>这一项，其他所有配置项都可以缺省不配置，框架会自动使用ConsumerConfig，ServiceConfig, ProviderConfig等提供的缺省配置。</p>
<h3 id="4-6-Dubbo-支持多版本、多注册中心、多协议暴露服务"><a href="#4-6-Dubbo-支持多版本、多注册中心、多协议暴露服务" class="headerlink" title="4.6 Dubbo 支持多版本、多注册中心、多协议暴露服务"></a>4.6 Dubbo 支持多版本、多注册中心、多协议暴露服务</h3><ul>
<li><p>支持的协议</p>
<ul>
<li>dubbo</li>
<li>rmi</li>
<li>hessian</li>
<li>http</li>
<li>webservice</li>
<li>thrift</li>
<li>Memcached</li>
<li>redis</li>
<li>rest</li>
<li>grpc</li>
</ul>
<blockquote>
<p>重点：dubbo协议、长连接、hessian序列化、NIO异步通信</p>
</blockquote>
<ul>
<li>dubbo协议（默认）：单一长连接，基于hessian序列化。NIO异步通信。适合传输数据量小（100kb以内），高并发的场景</li>
<li>rmi协议：基于java二进制序列化，适用于文件传输，使用较少。</li>
<li>hessian协议：基于hessian序列化，适用于provider比consumer还多的场景，适用于文件传输，较少使用。</li>
<li>http协议：基于json序列化。</li>
<li>webservice协议：基于soap文本序列化。</li>
</ul>
</li>
</ul>
<p>详见:<a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/introduction.html" target="_blank" rel="noopener">DUBBO用户文档</a></p>
<h2 id="五、常见面试问题"><a href="#五、常见面试问题" class="headerlink" title="五、常见面试问题"></a>五、常见面试问题</h2><h3 id="5-1-dubbo-工作原理是什么？"><a href="#5-1-dubbo-工作原理是什么？" class="headerlink" title="5.1 dubbo 工作原理是什么？"></a>5.1 dubbo 工作原理是什么？</h3><blockquote>
<p>重点：服务注册、注册中心、消费者、代理通信、负载均衡</p>
</blockquote>
<p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705180203.jpg" alt="/dev-guide/images/dubbo-framework.jpg"></p>
<ul>
<li>Dubbo框架设计一共划分了10个层，而最上面的Service层是留给实际想要使用Dubbo开发分布式服务的开发者实现业务逻辑的接口层。图中左边淡蓝背景的为服务消费方使用的接口，右边淡绿色背景的为服务提供方使用的接口， 位于中轴线上的为双方都用到的接口。<br>下面，结合Dubbo官方文档，我们分别理解一下框架分层架构中，各个层次的设计要点：<ol>
<li>服务接口层（Service）：该层是与实际业务逻辑相关的，根据服务提供方和服务消费方的业务设计对应的接口和实现。</li>
<li>配置层（Config）：对外配置接口，以ServiceConfig和ReferenceConfig为中心，可以直接new配置类，也可以通过spring解析配置生成配置类。</li>
<li>服务代理层（Proxy）：服务接口透明代理，生成服务的客户端Stub和服务器端Skeleton，以ServiceProxy为中心，扩展接口为ProxyFactory。</li>
<li>服务注册层（Registry）：封装服务地址的注册与发现，以服务URL为中心，扩展接口为RegistryFactory、Registry和RegistryService。可能没有服务注册中心，此时服务提供方直接暴露服务。</li>
<li>集群层（Cluster）：封装多个提供者的路由及负载均衡，并桥接注册中心，以Invoker为中心，扩展接口为Cluster、Directory、Router和LoadBalance。将多个服务提供方组合为一个服务提供方，实现对服务消费方来透明，只需要与一个服务提供方进行交互。</li>
<li>监控层（Monitor）：RPC调用次数和调用时间监控，以Statistics为中心，扩展接口为MonitorFactory、Monitor和MonitorService。</li>
<li>远程调用层（Protocol）：封将RPC调用，以Invocation和Result为中心，扩展接口为Protocol、Invoker和Exporter。Protocol是服务域，它是Invoker暴露和引用的主功能入口，它负责Invoker的生命周期管理。Invoker是实体域，它是Dubbo的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起invoke调用，它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现。</li>
<li>信息交换层（Exchange）：封装请求响应模式，同步转异步，以Request和Response为中心，扩展接口为Exchanger、ExchangeChannel、ExchangeClient和ExchangeServer。</li>
<li>网络传输层（Transport）：抽象mina和netty为统一接口，以Message为中心，扩展接口为Channel、Transporter、Client、Server和Codec。</li>
<li>数据序列化层（Serialize）：可复用的一些工具，扩展接口为Serialization、 ObjectInput、ObjectOutput和ThreadPool。</li>
</ol>
</li>
</ul>
<blockquote>
<p>服务暴露的过程</p>
</blockquote>
<ol>
<li>解析配置文件</li>
<li>在providerBean和consumerBean 初始化的时候吧配置信息set到Bean中</li>
<li>服务暴露<ol>
<li>获取注册中心地址和协议</li>
<li>proxyFactory获取Invoker执行器</li>
<li>包装并暴露执行器（注册中心协议（dubbo）和 传输协议（zk）Protocol 的export方法）  ==SPI==</li>
<li>创建启动netty服务器监听provider端口，获取对应协议的（dubbo）invoker </li>
<li>保存（本地的服务订阅注册表）providerInvoker 信息</li>
</ol>
</li>
</ol>
<p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705184037.png" alt="img"></p>
<blockquote>
<p>服务引用的过程</p>
</blockquote>
<ol>
<li>调用 FactoryBean（ReferenceBean）的get方法获取@DubboReference注解的对象</li>
<li>根据配置信息创建 需要的reference对象的代理对象 （注册中心协议（dubbo）和 传输协议（zk）Protocol 的refer方法）==SPI==</li>
<li>获取注册中心信息，并订阅对应服务</li>
<li>创建netty客户端并监听端口，获取 对应协议的（dubbo）invoker</li>
<li>保存（本地的服务订阅注册表）的consumerinvoker</li>
</ol>
<p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705184116.png" alt="img"></p>
<blockquote>
<p>方法调用过程</p>
</blockquote>
<ol>
<li>@DubboReference 注入的Bean是一个proxyBean，执行.invoke方法</li>
<li>把需要执行的方法和参数封装成一个Rpcinvocation对象</li>
<li>进入Filter执行 local(Stub)/mock/cache 操作（本地存根、本地伪装（服务降级）、结果缓存）</li>
<li>进入 Cluster 执行集群容错相关操作（容错策略和重试）</li>
<li>从注册中心获取相关invoker  List（多版本和多集群）</li>
<li>进入 LoadBalance 执行负载均衡策略 ，根据策略选择一个 invoker</li>
<li>进入监控统计信息 Filter 记录监控信息</li>
<li>进入协议 invoker ，根据对应协议使用netty客户端发送请求</li>
<li>客户端获取返回结果，封装原路返回</li>
</ol>
<p><img src= "/img/loading.gif" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200705194959.jpg" alt="/dev-guide/images/dubbo-extension.jpg"></p>
<ol>
<li><p>第一步》provider启动并向注册中心注册服务</p>
</li>
<li><p>第二步》consumer去注册中心订阅服务</p>
</li>
<li><p>第三步》consumer调用provider</p>
</li>
<li><p>第四步》consumer和provider异步通知监控中心monitor</p>
</li>
</ol>
<blockquote>
<p>当consumer第一次访问注册中心服务后，会在本地生成缓存，注册中心挂掉了还是可以访问服务的。</p>
</blockquote>
<ol>
<li><p>业务实现属于service层，篇日志文件属于config层，请求发起后service层调用proxy层生成动态代理类</p>
</li>
<li><p>proxy层动态代理类调用cluster集群层做负载均衡，确定服务地址，被monitor监控层监控。</p>
</li>
<li><p>调用protocol协议层组织请求、exchange信息交换层封装请求、serialize序列化层 、transport网络通信层（netty）</p>
</li>
</ol>
<p>   ==netty–&gt;NIO–&gt;selector–&gt;servicesocketchannel监听端口–&gt;==</p>
<h3 id="5-2-什么是SPI？怎样实现？"><a href="#5-2-什么是SPI？怎样实现？" class="headerlink" title="5.2 什么是SPI？怎样实现？"></a>5.2 什么是SPI？怎样实现？</h3><ul>
<li>SPI（service provider interface） 扩展接口的实现类，比如jdk中只提供了jdbc的接口，需要自己去导入具体实现类jar包。</li>
<li>实现方式：<ul>
<li>JAVA SPI ：META-INF/services 路径下创建一个文件名称为 要扩展的接口 的全限定名 。文件内容为实现类的全限定的类名</li>
<li>DUBBO SPI：META-INF/dubbo 路径下创建一个文件名称为 要扩展的接口 的全限定名。与 Java SPI 实现类配置不同，Dubbo SPI 是通过键值对的方式进行配置。另外，在测试 Dubbo SPI 时，需要在 接口上标注 @SPI 注解。</li>
</ul>
</li>
</ul>
<h3 id="5-3-基于dubbo如何进行服务治理、服务降级和重试？"><a href="#5-3-基于dubbo如何进行服务治理、服务降级和重试？" class="headerlink" title="5.3 基于dubbo如何进行服务治理、服务降级和重试？"></a>5.3 基于dubbo如何进行服务治理、服务降级和重试？</h3><ul>
<li>服务治理：<ol>
<li>生成调用链路图</li>
<li>服务访问压力和时长统计（调用次数和访问延时TP50 TP90 TP99）</li>
</ol>
</li>
<li>服务降级：<ol>
<li>在服务调用方配置mock参数：<br><code>&lt;dubbo:reference id=&quot;xxxService&quot; interface=&quot;com.x..service.xxxxService&quot; check=&quot;false&quot; mock=“123456&quot; /&gt; 降级则返回“123456”</code></li>
<li>以上配置mock=“true”的时候，需要自定义mock处理类。在接口服务xxxxService的目录下创建相应的mock业务处理类，同时实现业务接口xxxxService()，接口名要注意命名规范：接口名+Mock后缀，mock实现需要保证有无参的构造方法。</li>
</ol>
</li>
<li>重试：</li>
</ul>
<blockquote>
<p>retries，timeout，在配置文件中添加retries（重试次数）和timeout（最长超时时间）参数。</p>
</blockquote>
<h3 id="5-4-分布式系统如何保证系统的幂等性？"><a href="#5-4-分布式系统如何保证系统的幂等性？" class="headerlink" title="5.4 分布式系统如何保证系统的幂等性？"></a>5.4 分布式系统如何保证系统的幂等性？</h3><ol>
<li>在jvm或者缓存中做请求唯一记录，并做TTL（过期时间）和持久化（防止宕机主从切换时发生数据丢失）</li>
<li>记录请求记录状态信息（订单详情表）并设置唯一键。在接受到请求后先添加请求记录成功后再处理请求。</li>
<li>在请求记录中加入请求状态（比如订单处理状态），在处理订单钱先查询该订单状态。（加锁）</li>
</ol>
<h3 id="5-5-如何保证分布式系统接口调用的顺序性？"><a href="#5-5-如何保证分布式系统接口调用的顺序性？" class="headerlink" title="5.5 如何保证分布式系统接口调用的顺序性？"></a>5.5 如何保证分布式系统接口调用的顺序性？</h3><ol>
<li>在调用分布式接口服务之前，加入一套接口接入服务，（比如一致性hash算法）保证同一个请求调用的接口转发到一台机器上。</li>
<li>如果分布式接口的服务是多线程的，可以用内存队列来保证同一个请求对数据库的操作在同一个队列中供线程获取。</li>
<li>如果特别要保证100%的顺序性，使用分布式锁。（需要请求标识和顺序标识）</li>
</ol>
<h3 id="如何设计一个类似dubbo的rpc框架？"><a href="#如何设计一个类似dubbo的rpc框架？" class="headerlink" title="如何设计一个类似dubbo的rpc框架？"></a>如何设计一个类似dubbo的rpc框架？</h3><ul>
<li>基于zk做一个注册中心=====》</li>
<li>消费者需要去注册中心拿请求====》</li>
<li>面向接口的动态代理获取对应部署的机器地址===》</li>
<li>负载均衡算法 ===》</li>
<li>发送请求 nio方式 hessian协议 ===》</li>
<li>服务器动态代理监听某端口，代理本具体实现。</li>
</ul>
<h3 id="5-6-dubbo的负载均衡策略、集群容错策略、动态代理策略"><a href="#5-6-dubbo的负载均衡策略、集群容错策略、动态代理策略" class="headerlink" title="5.6 dubbo的负载均衡策略、集群容错策略、动态代理策略"></a>5.6 dubbo的负载均衡策略、集群容错策略、动态代理策略</h3><ol>
<li>负载均衡策略：<ul>
<li>random loadbalance（默认） 根据配置权重随机分配</li>
<li>roundrobin loadbalace 轮循</li>
<li>leastactive loadbalance 自动感知不活跃的机器（性能差的）使其更少地分配到</li>
<li>consiistanthash loadbalance 一致性hash算法 使一类请求分布到一台机器上</li>
</ul>
</li>
<li>集群容错策略：<ul>
<li>failover cluster模式 （默认） 失败自动切换，常见于读操作</li>
<li>failfast cluster模式 一次失败立即报错，常见于写操作。</li>
<li>failsafe cluster模式 出现异常时忽略，常用语不重要的接口调用 比如日志</li>
<li>failback cluster模式 失败后自动记录请求，定时重发，适用于消息队列</li>
<li>forking cluster模式 并行调用多台机器，只要有一个返回就立即响应。</li>
<li>broadcast cluster模式 逐个调用所有机器</li>
</ul>
</li>
<li>动态代理策略：</li>
</ol>
<blockquote>
<p>默认使用javassist动态字节码生成，创建代理类。也可以通过spi扩展机制配置自己的动态代理策略。</p>
</blockquote>
<p><strong>参考链接</strong></p>
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/index.html" target="_blank" rel="noopener">http://dubbo.apache.org/zh-cn/index.html</a></li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/new-features-in-a-glance.html" target="_blank" rel="noopener">http://dubbo.apache.org/zh-cn/docs/user/new-features-in-a-glance.html</a></li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">NicZSAMA</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gakkisama.com/2020/07/05/Dubbo/">http://gakkisama.com/2020/07/05/Dubbo/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gakkisama.com" target="_blank">o.0</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200726232916.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/07/10/Netty/"><img class="prev-cover" data-src="https://nicspichost.oss-cn-beijing.aliyuncs.com/blog/20200710110543.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">I/O 和 Netty</div></div></a></div><div class="next-post pull-right"><a href="/2020/06/28/Swagger/"><img class="next-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Swagger</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By NicZSAMA</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">繁</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>